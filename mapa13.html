<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa con OpenStreetMap y Clima</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Estilos anteriores (sin cambios) */
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <button id="getLocation" class="btn btn-update">Actualizar Posición</button>
        <select id="mapLayers">
            <option value="osm">Mapa Estándar</option>
            <option value="satellite">Satélite</option>
            <option value="temperatura">Mapa del Clima</option>
        </select>
        <button id="centerMap" class="btn btn-center">Centrar en Ubicación</button>
    </div>
    <div id="location-info">Esperando ubicación...</div>
    <div id="weather-info">Cargando clima...</div>
    <button id="saveLocation" class="btn">Guardar ubicación actual</button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const API_KEY = "2368e0b9c1a77bad8b4bb745bfe21ecb"; // clave de OpenWeatherMap
            let map = L.map('map').setView([0, 0], 15);
            let userMarker = null;
            let currentLat = null;
            let currentLon = null;
            let precisionCircle = null;
            let savedMarker = null;

            // Definir un ícono de auto rojo para el marcador de "Lugar Guardado"
            const redCarIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/Chatlas2023/Iconos/main/Auto_Rojo.png', // URL del ícono de auto rojo
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', // Sombra del ícono
                iconSize: [40, 40], // Tamaño del ícono (ajusta según el tamaño de la imagen)
                iconAnchor: [20, 40], // Punto de anclaje del ícono (centro en la parte inferior)
                popupAnchor: [1, -34], // Punto de anclaje del popup
                shadowSize: [41, 41] // Tamaño de la sombra
            });

            let layers = {
                osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 22,
                    attribution: '&copy; OpenStreetMap contributors'
                }),
                satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    maxZoom: 19,
                    attribution: '&copy; Esri'
                })
            };

            layers.osm.addTo(map);
            map.on('zoomend', function () {
                if (map.getZoom() > 19) {
                    map.setZoom(19); // Limitar el zoom a 19
                }
            });

            // Función para guardar la ubicación actual
            function guardarUbicacion() {
                if (currentLat && currentLon) {
                    // Guardar en localStorage
                    localStorage.setItem('savedLocation', JSON.stringify({ lat: currentLat, lon: currentLon }));
                    mostrarMarcadorGuardado(currentLat, currentLon);
                } else {
                    alert("No se ha obtenido la ubicación actual.");
                }
            }

            // Función para mostrar el marcador del lugar guardado
            function mostrarMarcadorGuardado(lat, lon) {
                if (savedMarker) {
                    // Cerrar el popup existente
                    savedMarker.closePopup();
                    // Mover el marcador a la nueva ubicación
                    savedMarker.setLatLng([lat, lon]);
                } else {
                    // Crear un nuevo marcador si no existe, usando el ícono de auto rojo
                    savedMarker = L.marker([lat, lon], {
                        title: "Lugar guardado",
                        icon: redCarIcon // Asignar el ícono de auto rojo
                    }).addTo(map);
                }
                // Abrir un nuevo popup con el mensaje "Lugar guardado"
                savedMarker.bindPopup("Lugar guardado").openPopup();
            }

            // Recuperar la ubicación guardada al cargar la página
            function cargarUbicacionGuardada() {
                const savedLocation = localStorage.getItem('savedLocation');
                if (savedLocation) {
                    const { lat, lon } = JSON.parse(savedLocation);
                    mostrarMarcadorGuardado(lat, lon);
                }
            }

            // Cargar la ubicación guardada al iniciar
            cargarUbicacionGuardada();

            // Evento para el botón de guardar ubicación
            document.getElementById("saveLocation").addEventListener("click", guardarUbicacion);

            // Resto del código (sin cambios)
        });
    </script>
</body>
</html>
